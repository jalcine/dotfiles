#!/usr/bin/env zsh
# shellcheck disable=SC2086,SC2038,SC2154,SC2086

eval "$(keychain --quiet --attempts 3 --inherit any-once --eval --agents ssh,gpg --ignore-missing $KEYCHAIN_GPG_KEYS)";

for key in $(find $HOME/.ssh/keys -type f -name "*.pem" | xargs)
do
  declare passPath=$(basename $(dirname ${key}))
  declare passDir=$(basename -s .pem "${key}")

  echo "[keychain] Importing SSH key '${passPath}/${passDir}'...";
  pass show "ssh${KEYCHAIN_PASSWORD_PREFIX:-}/${passPath}/${passDir}" | ssh-add "${key}" 2>~/.keychain/startup_err.log >~/.keychain/startup.log
done
